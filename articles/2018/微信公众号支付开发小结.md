### 支付参数

微信支付需要的参数多且分散，刚接触的人比较容易疑惑，主要原因是官方文档不是很好懂，其结构不是很清晰，有些关键点本应连贯起来才好理解，但文档却写得比较分散。例如，使用微信浏览器内置对象`WeixinJSBridge`拉起支付页面，需要配置一些参数，[官方文档](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_7&index=6)是这样描述的，前端开发人员看了可能会分不清，这些参数是从自家服务端获取？还是由前端生成的？

因此我列出以下步骤，按照这样的顺序开发会更容易理解各个参数的来源。

1. 获取openId
1. 微信下单（后端调用微信统一下单接口，所需参数官方文档写得很清楚）
1. h5拉起微信支付页面（前端需要的参数均可从上一步获取）
2. 查询微信订单（后端调用微信查询订单接口）
3. 以上如果支付成功，可以试试关闭订单、申请退款、查询退款等接口

如果有条件（知道AppSecret、ApiKey、AppID），最好尝试独立完成微信支付的所有步骤，后端部分可以用`Koa2`，学习成本不高；
如果没有条件，那么恭喜你，你需要的参数只管跟后端要就行了，so easy！

### 网页授权域名只能设置一个

在公众平台上只能设置一个授权域名，这就意味着在向微信服务器请求授权时，只有一个域名能作为`redirect_uri`参数的值，如果有多个网站需要微信授权（比如微信登录），则域名就不够用了。

这个问题在网上很容易找到解决方案，就是增加一个中转服务器，把授权的域名给这个服务器，获取微信授权的事就交给这个中转服务器，然后自家的网站，需要微信授权的都先请求这个中转服务器，这个中转服务器再向微信服务器请求授权，获取到授权信息后再给到自家网站。

这里除了把网上的解决方案抄一遍，还想提一下的是：这个中转服务不但有必要存在，而且还应该由前端来写，这样前端可以减少对后端的依赖，使得前端的能力范围更广。比如，你需要获取外域的一个资源，如果由浏览器获取会因跨域而失败，那么你可以在这个中转服务器上加多一个接口，让服务器帮你获取就可以了。

### 本地调试

出于安全性考虑吧，只有在商户平台配置的几个域名（最多5个）才能拉起微信支付。所以在线上环境可以开发调试，但在线上做很不方便。所以让本地机器具有一个可用域名才是王道。

这里最容易想到的解决方案是：**内网穿透**

使用内网穿透需要一些成本，需要买个服务器和域名，本人使用的内网穿透方案是[frp](https://github.com/fatedier/frp)。其实程序员买个服务器挺有必要的，可以玩很多技术，如果买国外或香港这些服务器，还可以搭个vpn翻墙，比起单独买vpn划算多了。

内网穿透是个好东西，很多场合可以使用，不过针对微信支付这点就有些局限性了。比如服务器的配置不是很高，那么响应速度就比较慢，影响开发体验；再者，当项目上线后，授权域名不能随便更改，那么内网穿透用不了这个授权的域名，也就玩不下去了。

当然，还有个方法可以继续玩下去：**代理**

这个方法其实更好用，还不需要什么成本，至少都是免费的。

代理的方式很多，比如修改`hosts`文件。不过在手机上修改`hosts`比较麻烦，ios要越狱，安卓要ROOT，当调试完想测试正式环境时要改回来，继续调试又要再改回去。并且这里涉及到安全问题，自己的私人手机真不想ROOT。

另外有一个比较好的方法，就是用代理软件。对于前端来说不需要特意安装新软件，一般抓包工具都有代理的功能。比如`charles`，入口是：`Tools -> Map Remote`。手动添加记录，把指定域名代理到本机的服务端口，然后手机连接`charles`的代理，这样就可以把手机发出去的请求代理到本地服务了。在PC上发送的请求也可以通过`charles`代理到本地，比如微信开发者工具可在`设置 -> 代理设置`设置代理信息。

具体怎么使用`charles`这里就不多写了，网上很多。

### 踩过的坑

说到踩坑，其实就踩了一个。整体来说，虽然一开始看官方文档比较懵逼，但结合网友的经验，再多试几次还是可以的。虽然坑不多，但足够把人坑惨。

我踩的坑是这样的，在拉起**沙箱版**的微信支付时，前端会抛出“total_fee不正确”的错误，我就是在这里卡了很久，因为`total_fee`参数的值真没问题，后来多试几次，错误还变成是其他参数不正确了，但其他参数也是没问题的呀，所以当时就认定这是个坑了。

关于沙箱版支付的官方文档很难找，当时费了很大劲才找到（现在又找不到了，也没动力找了），记得文档是这么说的：沙箱版的微信支付在调用`WeixinJSBridge`时不会拉起支付页面，而是直接进入支付后的回调函数，如果参数配置正确，则返回支付成功，反之返回支付失败。我试了N次，结果都和文档描述的不一样。

最后实在没辙，就试一下微信的其他接口是不是也有什么奇葩问题，试了一下微信查询订单的接口，结果发现订单状态竟然是已支付！！是已支付！！是已支付！！纳尼，赶紧试多了几次，原来那个报错不会影响支付结果！！与文档说的不一样，支付成功并没有返回成功的信息，而是抛出一个不应该被抛出的错误。我的天，这文档写的，还可以无视一个业务性程序错误，继续业务流程，amazing。
