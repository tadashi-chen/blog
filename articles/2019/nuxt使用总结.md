前段时间，为了能实现SEO，把一个`Vue CLI`的项目改为服务端渲染，使用`Nuxt`，好在项目的业务比较简单，做起来不会很费力。

#### 从`Vue CLI`到`Nuxt`主要做以下几点修改：

1. 把业务组件文件按路由的层级关系设置好目录结构，因为`nuxt`的路由是按照业务组件的目录结构自动生成的
1. 原本在`created`或`mounted`钩子里请求数据，再用数据渲染页面，修改为使用`asyncData`请求数据
1. 原本在`index.html`文件里的配置，迁移到`nuxt.config.js`里
1. 原本`App.vue`使用布局`layouts`代替
1. 仅在服务端运行的代码，需要放在条件`if (process.server) {}`里；仅在客户端运行的代码，需要放在条件`if (process.client) {}`里

#### Koa2模板

使用`Nuxt`的服务端渲染模式，则必须要有一个`Node.js`服务，`Nuxt`提供了`Express`模板、`Koa`模板和默认模板。当然优先选择`Koa`模板了，熟悉又好用。

这里有一点需要注意，`Nuxt`的官方文档提供了两个部署命令`nuxt build`和`nuxt start`,`nuxt build`这个命令是通用的，而`nuxt start`是针对选择了默认模板的情况，其对应`pm2`的启用命令为`pm2 start npm -- start`，`start`对应脚本为`nuxt start`。

如果使用了`Koa`模板，则应该使用入口文件`server/index.js`启动。

#### 内存泄漏

原来的业务代码存在内存泄漏问题，在浏览器上问题并不明显，但改为服务端渲染后，服务端的内存就很容易爆了。

在排查内存泄漏的问题过程中发现一个很好玩的问题：

如果使用`nuxt start`命令部署，即不走`Koa`的代码，这种情况下`Nuxt`对内存问题处理的非常好。虽然业务代码存在内存泄漏问题，但使用并发工具去压测，并不能把服务器使用内存提高，不清楚`Nuxt`是做了什么处理，总之很牛逼。而且同样的业务代码，使用默认模板只需要45M左右的内存，而使用`Koa`模板需要75M左右。

如果使用`pm2 start server/index.js`命令部署，即走`Koa`的代码，内存泄漏很明显，稍微压测一下内存就上去了，上去后还下不来了。在解决了业务代码的内存泄漏问题后，压测时内存依旧会上去，但是没那么夸张了，而且过一会会降下来。

所以，以后使用`Nuxt`还是优先使用默认模板为好。

#### 踩坑

在业务代码上遇到了一个坑，是这样的：

在一个DOM节点使用`v-if="showNow"`，`showNow`的初始值为`false`，在浏览器上触发事件更改`showNow`为`true`，理论上该DOM节点应该由不显示变为显示，在开发模式下（`npm run dev`）表现正常，但是经过`nuxt build`运行在`pm2`下时，就不显示了。而把`v-if`改为`v-show`则就正常了，这很有可能是`nuxt build`这一步存在问题，应该就是`Nuxt`的锅了。
